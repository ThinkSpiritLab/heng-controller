- [快速上手](#快速上手)
- [外部模块开发者手册](#外部模块开发者手册)
- [评测机交互模块开发者手册](#评测机交互模块开发者手册)
- [调试](#调试)

从模块基于 Redis 的 `Set` 和 `List` 简单实现了令牌桶算法。

此模块依赖 `RedisModule`，向外部模块提供 `JudgeQueueService`， 向评测机交互模块提供 `JudgerPoolService`。

同时本模块在 `Controller` 中开放了一些用于调试的接口。

## 快速上手

在自己的模块中导入 `SchedulerModule`：
```ts
@Module({
    imports: [SchedulerModule],
    controllers: [YourController],
    providers: [YourProviders]
})
```

注入 `Service`：
```ts
constructor(
    private readonly judgeQueueService： JudgeQueueService,
) {}
constructor(
    private readonly judgerPoolService JudgerPoolService,
) {}
```

具体使用请参考 [外部模块开发者手册](##外部模块开发者手册)、[评测机交互模块开发者手册](##评测机交互模块开发者手册)、[测试手册](##测试手册)

## 外部模块开发者手册

外部模块请注入 `JudgeQueueService`。

1. `push` 向评测队列插入任务，返回 `taskid`。 请调用者维护任务其他信息。
   ```ts
   push = async (taskid: string) => Promise<string>;
   ```

## 评测机交互模块开发者手册

评测机交互模块请注入 `JudgerPoolService`。

1. `login` 向评测机池注册一台评测机。
   ```ts
   login = async (judgerId: string, capacity: number) => Promise<number>;
   ```
   返回值目前仅作为保留。
   注意 `judgerId` 中，冒号（":"）留作特殊用处使用。用户构造的 `judgerId` 不应再包含冒号。

2. `logout` 通知评测机池注销一台评测机。
   ```ts
   logout = async (judgerId: string) => Promise<number>;
   ```
   返回值目前仅作为保留。
   注意此方法不负责检查 `judgerId` 是否合法。

3. `getToken` 获取一个令牌和释放此令牌的回调函数。
   ```ts
   getToken = async () => Promise<[string, () => Promise<void>]>;
   ```
   此令牌就是一个评测机标识符。评测完成后，务必调用回调函数释放令牌。

## 调试

本模块在 Redis 中维护了三个键：
`JudgeQueue:pendingQueue`、`JudgerPool:tokenCount`、`JudgerPool:tokenBucket`，分别是当前评测队列、令牌数量，所有令牌的集合。

 `JudgeQueue:pendingQueue` List， 保存 taskid。

`JudgerPool:tokenCount` List，中每一个元素对应一个令牌，他们互相没有区别，仅用于
当令牌为空时阻塞 Redis。

`JudgerPool:tokenBucket` Set， 包含所有令牌，其格式为「评测机标识符:属于该评测机的令牌序号」。 


1. POST `/test/scheduler/judgeQueue/push`
   
   接受一个 `CreateJudgeRequest`，并立刻以其 `taskId` 字段调用评测队列的 `push` 。

2. POST `/test/scheduler/JudgerPool/login|logout`
   
    向 `login` 的请求应包含两个字段："name"，"maxTaskCount"，分别指代评测机标识，评测能力。

    向 `logout` 的请求包含两个字段："name"，"maxTaskCount"，分别指代评测机标识，评测能力。