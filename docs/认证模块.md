

# 认证模块

## RoleSignGuard

主要内容。

作用：

1. 根据请求中提供的AccessKey及http签名验证其角色
2. 验证http请求是否被窜改

## KeyModule

提供密钥对及其所具有的权限的CRUD接口，使用Redis存放各角色的密钥对，实现方法为为各角色开一个Hash

### 接口

※**只有root才可访问**

1. POST `/gennerate?roles=$role1,$role2...`

    - ``` generateAddKeyPair```根据请求参数roles签发具有对应角色的密钥对并加入redis

2. DELETE `/del?ak=$AccessKey&roles=$role1,$role2..`

    - `deleteKeyPair`删除密钥对

3. GET `/getall`

    - `getAllKeyPairs`获取所有密钥对

4. GET `/get?ak=$AccessKey(&role=$role)`

    - `getKeyPairByAK`根据AccessKey和可选参数role获取密钥对，暂不支持根据多个role获取

5. POST `/add`

    - 向add的请求应包含一个KeyPair类型具有的字段"ak","sk",“role"（可选）

      [KeyPair的格式]: #KeyPair
      
      


### 服务

1. `generateAddKeyPair` 生成一个具有密钥对roles中含有的角色的密钥对

```typescript
async generateAddKeyPair(roles: string[]): Promise<KeyPair>;
```
2. `deleteKeyPair`根据公钥accessKey删除密钥对或其具有的角色，若不提供角色，默认删除所有角色。

```typescript
async deleteKeyPair(
  accessKey: string,
  roles?: string[]
): Promise<{ RemovedRoles: string[]; SccessNum: number }>;
```
3. 获取所有密钥对，返回一个键为角色类型，值为密钥对列表的KeyListsDic

[KeyListsDic]: #KeyListsDic




```typescript
async getAllKeyPairs(): Promise<KeyListsDic>；
```
```typescript
async getKeyPair(accessKey: string, role?: string): Promise<KeyPair>；
```

```typescript
async addKeyPair(keyPair: KeyPair): Promise<number>
```



## 常量及类型

###  ```RoleTypeArr:string[]```

内容：```["root", "admin", "judger", "user"]```

存角色的数组

### ```PublicHeadersType:string[]```

公共请求头，在guard中使用（遍历）时按字典序排序

```whiteHeaders:string[]```

请求头白名单，计入签名

### KeyPair

 ```typescript
type KeyPair = {
    ak: string | null;
    sk: string | null;
    roles?: string[] | null;
};
 ```

密钥对格式。```ak:AccessKey``` ``` sk:SecretKey``` ``` roles:密钥对具有的角色```

### Dictionary

手动创建一个字典类型

```typescript
interface Dictionary<T = any> {
    [key: string]: T;
}
```

### KeyListsDic 

保存各个角色对应的密钥对的列表的字典


```typesctipt
type KeyListsDic = Dictionary<Record<string, string>>;
```
eg:

```typescript
{
"root":{
  "blablaba":"blablabla"
},
"admin":{
  "blablaba":"blablabla",
    "blablaba":"blablabla"
},
"judger":{
  "blablaba":"blablabla",
    "blablaba":"blablabla"
}
}
```


### key 的长度

root：64-256

其他：64

生成方式：`generateKeyPairSync()`,带有PUBLICKEY/SECETKEY等字样的前缀或后缀，需截取中间部分1到4行，取中间64位。

在日志中输出accessKey时取前6位

## AuthPipe（）

构造参数vals[]: 表示请求中(或controller中)的参数应属于vals[]中的内容，为空则无限制，

写着以备以后增加验证机制？

## AuthFilter

为以后扩展而加的过滤器？目前还没有重要作用